# FR Arbitrage Bot v2 - 要求定義 & タスク計画

## 1. システム概要

Funding Rate（FR）の鞘取りを自動化するBot。
メインウォレットに資金を集中管理し、FR機会を検出したら対象取引所に送金→ポジション構築→FR回収→撤収を自動で行う。

### コンセプト
```
メインウォレット (USDC on Arbitrum)
    │
    ├─ [Scanner] FR機会検出
    │       ↓
    ├─ [Fund Router] 最安ルートで送金
    │       ↓
    ├─ [Executor] デルタニュートラル構築（現物L + パープS）
    │       ↓
    ├─ [Collector] FR回収（1h毎に1/8ずつ適用）× N サイクル
    │       ↓
    ├─ [Portfolio Manager] 乗り換え判定（全コスト+ベーシス込みNet P&L）
    │       ↓
    └─ [Withdrawer] 決済 → メインウォレットに出金
```

---

## 2. 要求定義

### 2.1 機能要求

#### FR Scanner（常時稼働）
- [ ] Loris API で全取引所のFRを定期監視（1分〜5分間隔）
- [ ] 各取引所APIで個別FR取得（Loris障害時のフォールバック）
- [ ] **Loris APIヘルスチェック**: 3回連続失敗でフォールバック自動切替 + アラート
- [ ] **FR値キャッシュ**: 最終取得値+タイムスタンプを保持、古いデータでの発注防止
- [ ] フィルタ条件:
  - FR >= 閾値（デフォルト 0.1% / 8h）
  - OI >= 最低額（デフォルト $1M — $500Kは板が薄すぎる）
  - 24h出来高 >= 最低額
  - スプレッド（bid-ask）<= 最大値
  - **板厚チェック**: ±0.5%以内の累積流動性 >= ポジションサイズの20倍
  - **HL Spotペア存在チェック**: デルタニュートラル構築可能か事前確認
- [ ] 取引所間FR差（アービトラージ）の検出
- [ ] シグナル発火 → Fund Router に通知

#### Fund Router（送金管理）
- [ ] メインウォレット残高監視
- [ ] 送金ルート: **信頼済み固定リスト限定**（Arbitrum公式ブリッジ、Circle CCTP等のみ。自動最安ルート選択は禁止）
- [ ] 対象取引所への送金実行
- [ ] **トランザクションハッシュのDB永続化**（クラッシュ時に送金状態を追跡可能に）
- [ ] 着金確認（polling / websocket）**タイムアウト付き**（HL: 10分、CEX: 30分）
- [ ] 送金失敗時のリトライ（指数バックオフ）& アラート
- [ ] **ブリッジ障害時**: タイムアウト超過 → 手動介入アラート、新規ポジション構築停止

#### Executor（ポジション構築・決済）
- [ ] **エントリー直前FR再確認ゲートチェック**: 発注直前にFR再取得 → 閾値以上なら実行、未満ならキャンセル

**ヘッジモード自動選択:**
Scannerがシグナルを出した時点で、条件に応じてヘッジ方式を自動判定する。

```
if HL Spotペアあり & Spot板厚十分:
    → Mode A: Spot-Perp（HL内完結）
elif 対象ペアが他取引所Perpにもある & FR差が十分:
    → Mode B: Perp-Perp（クロス取引所）
else:
    → スキップ（ヘッジ不可）
```

- [ ] **Mode A: Spot-Perp**（Cash & Carry — HL内完結）
  - FR+ → HL現物ロング + HLパープショート
  - 1取引所で完結、資金効率が良い、清算リスクはパープ側のみ
  - **適用条件**: HL Spotペアあり & 板厚 >= ポジションサイズ×20倍
  - レバ: パープ側1.5x以下
- [ ] **Mode B: Perp-Perp**（クロス取引所ヘッジ）
  - FR高い側でショート + FR低い側でロング（ネットFR差分が利益）
  - 例: HL パープショート（FR 0.1%）+ Bybit パープロング（FR 0.02%）→ ネット +0.08%
  - **適用条件**: FR差（取引所間スプレッド）> 手数料コスト + 証拠金分割ロス
  - **証拠金分割**: 資金を2取引所に分散（例: 50:50）→ 資金効率低下を許容
  - **証拠金バランス監視（★重要）**:
    - 両側の証拠金率をリアルタイム監視
    - 片側30%以下 → アラート + 自動リバランス or 両側撤退
    - 急変動（10分で5%以上変動）→ 即時両側決済
  - レバ: **両側とも1.2x以下**（片寄りリスクのため Spot-Perp より保守的に）
- [ ] **Mode判定ログ**: なぜA/B/スキップを選んだか全記録
- [ ] FR- → **リスク認識の上で**パープロングのみ（方向性ポジション。サイズを通常の50%に制限）
- [ ] 指値注文（maker fee最小化）
- [ ] **片足約定対策**: 片方だけ約定してもう片方が未約定の場合、タイムアウト(30秒)後にtakerで強制約定 or 約定済み側も決済して撤退
- [ ] ポジションサイズ計算（Mode別レバ制限適用）
- [ ] 決済（指値）
- [ ] **ADL（自動デレバレッジ）検知**: 片側だけADLされた場合、もう片側も即決済してネイキッドポジション防止

#### Collector（FR回収監視）
- [ ] FR決済イベント監視（**HLは1時間毎に1/8ずつ適用**。CEXは8h毎）
- [ ] 累計収益トラッキング
- [ ] FR低下検出 → 撤収判断
- [ ] より良いペア発見 → Portfolio Managerに通知

#### Portfolio Manager（損益判定 & ローテーション）★コア

全ての判断の中枢。「乗り換えるべきか」を正確なP&L計算で決める。

**Net P&L 計算式（v2: ベーシス込み）:**
```
乗り換え純利益 =
  [FR収益差分]
    (新FR - 現FR) × 3回/日 × 想定保持日数 × ポジションサイズ

  - [ベーシス変動リスク]  ★追加
    現ポジション決済時のベーシス含み損益（現物-パープ価格差の変動）
    + 新ポジション構築時のベーシスコスト推定

  - [現ポジション決済コスト]
    手数料（maker想定、taker約定確率30-50%を加味）
    + スリッページ推定（±0.5%板厚から算出、OIではなく実板深度）

  - [送金コスト]
    ガス代（L2: ~$0.10）
    + ブリッジ手数料（取引所間の場合）
    + 送金待ち時間中の機会損失（現FRが得られない時間）

  - [新ポジション構築コスト]
    手数料（同上）
    + スリッページ推定
```

- [ ] 現ポジション一覧管理（ペア・取引所・FR・サイズ・累計PnL・**ベーシス含み損益**）
- [ ] リアルタイム Net P&L 計算:
  - 取引手数料（maker/taker × 取引所別、**taker約定確率を加味**）
  - スリッページ推定（**±0.5%板厚の累積流動性から算出**）
  - 送金コスト（ガス代 + ブリッジ手数料）
  - 送金時間中の機会損失
  - FR変動リスク（直近のFRボラティリティ）
  - **ベーシス変動**: 現物-パープ含み損益のリアルタイム追跡
- [ ] ローテーション判定:
  - `net_profit > ポジションサイズの0.05%` かつ `confidence > 閾値` → 乗り換え実行（**ヒステリシス付き**）
  - 最低保持期間（**デフォルト24h = 3 FR決済分**。構築コスト回収前の早期撤退防止）
  - **FR方向チェック**: 上昇中のFRと下降中のFRを区別（下降中は乗り換え非推奨）
- [ ] 複数ポジション同時管理:
  - 遊休資金あり → 新規追加（乗り換え不要）
  - 全額投入中 → 最低FR のポジションと新機会を比較（**構築コスト回収済みの場合のみ**）
  - 最大同時ポジション数制限（デフォルト3）
  - **相関リスク監視**: 全ポジションが同方向（全部FR+ショート等）の場合、急落時に一斉反転するリスクを警告
- [ ] 取引所別コストテーブル（**動的取得推奨、ティア変動あり**）:
  ```
  costs = {
    "hyperliquid": {"maker": 0.01%, "taker": 0.035%, "withdraw_gas": ~$0.10, "transfer_time": 300s},
    "bybit":       {"maker": 0.01%, "taker": 0.055%, "withdraw_fee": varies, "transfer_time": 600s},
    "mexc":        {"maker": 0.00%, "taker": 0.01%,  "withdraw_fee": varies, "transfer_time": 600s},
  }
  ```
- [ ] 判定ログ（なぜ乗り換えた/しなかったかを全記録）

#### Recovery Manager（状態復旧）★新規
- [ ] **起動時リカバリ**: 取引所APIからオープンポジション取得 → DBの記録と照合 → 不整合アラート
- [ ] **Sagaパターン**: ポジション構築/決済を複数ステップのステートマシンとして設計。各ステップをDBに記録してから次へ進む。中断時は再開可能
- [ ] **片足ポジション検知**: デルタニュートラルの片側だけ存在 → 即アラート + 自動修復 or 手動介入選択
- [ ] **送金中クラッシュ対応**: トランザクションハッシュからオンチェーンステータスを確認、資金の所在を特定

#### Withdrawer（出金管理）
- [ ] ポジション決済確認後、出金実行
- [ ] 最安ルートでメインウォレットへ（**固定リストのみ**）
- [ ] 出金完了確認
- [ ] **OKX出金制限対応**: ホワイトリスト登録後24h待ちが必要

#### Dashboard（監視UI）
- [ ] 現在のポジション一覧（リアルタイムNet PnL + **ベーシス含み損益**表示）
- [ ] 累計PnL（日次/月次）
- [ ] ローテーション履歴（乗り換え判定の詳細ログ）
- [ ] FR履歴チャート
- [ ] アラート履歴
- [ ] ウォレット残高
- [ ] **デルタエクスポージャー監視**（片足ポジション検知）

### 2.2 非機能要求

| 項目 | 要求 |
|------|------|
| 稼働時間 | 24/7（サーバー or VPS） |
| レイテンシ | Scanner: 5分以内、Executor: 30秒以内 |
| 対応取引所 | Phase1: Hyperliquid、Phase2: Bybit/OKX/MEXC |
| 通知 | Discord + Telegram（冗長化） |
| セキュリティ | **HL Agent Walletで権限分離**（後述） |
| ログ | 全トレードを JSON ログ保存、**ログローテーション付き** |
| リスク管理 | 最大ポジションサイズ制限、ドローダウン制限 |
| **状態復旧** | クラッシュ後の自動リカバリ（Recovery Manager） |
| **死活監視** | 外部ヘルスチェック（Healthchecks.io等） |
| **レートリミッター** | 取引所別Token BucketでAPI呼び出し制御 |
| **Graceful Shutdown** | SIGTERM → 新規操作停止 → 進行中完了待ち → 状態保存 → 終了 |

### 2.3 対応取引所

> **重要: 日本居住者はBybit/OKX/Binanceのグローバル版（先物対応）を利用できない。**
> 日本版は先物機能が制限されている。そのため**DEX中心**で構成する。

#### DEX（規制リスクなし — コア）

| 取引所 | 接続方式 | Maker | Taker | Phase | 備考 |
|--------|----------|-------|-------|-------|------|
| **Hyperliquid** | hyperliquid-python-sdk（Agent Wallet） | 0.01% | 0.035% | **Phase1** | メイン。KYC不要。Spot+Perp |
| **GMX** | ethers.js / GMX SDK | 0.05% | 0.07% | Phase4 | Arbitrum。Perp-Perpのロング側 |
| **dYdX** | dydx-v4-client | 0.02% | 0.05% | Phase4 | Cosmos。板が厚い主要ペア向け |

#### CEX — FSA警告なし（比較的安全）

| 取引所 | 接続方式 | Maker | Taker | Phase | 備考 |
|--------|----------|-------|-------|-------|------|
| **BingX** | REST + WebSocket API | 0.02% | 0.04% | Phase4 | **最推奨CEX**。FSA警告なし、アプリ削除なし、日本語対応 |
| **Phemex** | REST + WebSocket API | 0.01% | 0.06% | Phase4 | FSA警告なし。Maker手数料安い |
| **CoinEx** | REST + WebSocket API | 0.03% | 0.05% | Phase4 | FSA警告なし。KYC不要の報告あり |
| **BTCC** | REST + WebSocket API | 0.03% | 0.06% | Phase5 | ライセンス実績あり |

#### CEX — FSA警告済み（グレーゾーン、アプリ削除済みだがWeb利用可）

| 取引所 | 接続方式 | Maker | Taker | Phase | 備考 |
|--------|----------|-------|-------|-------|------|
| **MEXC** | **Playwright**（先物API禁止） | 0.00% | 0.02% | Phase5 | 手数料最安だがアプリ削除済み。Playwright必須。規制+BANリスク |
| **Bitget** | REST + WebSocket API | 0.02% | 0.06% | Phase5 | 日本語充実。FSA警告済み |
| **KuCoin** | REST + WebSocket API | 0.02% | 0.06% | Phase5 | Bybit同様の撤退リスクあり |

#### 利用不可

| 取引所 | 理由 |
|--------|------|
| ~~Bybit~~ | 撤退進行中（2025年12月〜） |
| ~~OKX~~ | 日本撤退済み |
| ~~Binance~~ | 日本版は先物なし |
| ~~Gate.io~~ | 完全撤退済（2024年7月） |
| ~~XT.com~~ | 日本を公式ブロック |

> **方針**: DEXをコアに据えつつ、**FRが美味しいCEXがあれば取りに行く**。
> DEXで取れないFR機会をCEXで拾う「DEXファースト + CEX補完」構成。
>
> **CEX利用時の注意**:
> - FSA警告なしの取引所を優先（BingX, Phemex, CoinEx）
> - **APIキーはIP制限 + 出金不可で発行**
> - CEXには最小限の資金のみ（1ポジション分）、大口はウォレットに保管
> - 規制環境の変化に備え、CEXからの即時撤退手順を常に用意
> - グレーゾーンCEX（MEXC, Bitget, KuCoin）は規制強化リスクを受容した上で利用

> **MEXC特記**: 先物APIが禁止のためPlaywrightでブラウザ操作を自動化。
> - 手数料は最安水準（Maker 0%, Taker 0.02%）で魅力的
> - ただし**アプリ削除済み + アカウントBANリスク + 資金凍結リスク**
> - VIPアカウント申請（API制限解除の可能性）を先に調査

**Phase 1 は Hyperliquid のみ** → APIキー不要、ウォレットだけで完結。
**Phase 4 で DEX（GMX/dYdX）+ CEX（BingX/Phemex）追加** → FR機会を最大化。

### 2.4 Hyperliquid 固有の注意事項 ★新規

| 項目 | 内容 |
|------|------|
| **Spot市場の流動性** | HLのSpotは板が薄い/ペアが存在しない銘柄が多い。Cash&Carryが組めるのはBTC, ETH, HYPE等の主要銘柄に限定。FRが高いミーム系はSpotなしが多い |
| **Funding間隔** | rateは8h表記だが、**1時間ごとに1/8が適用される**。8h毎の一括決済ではない |
| **ADL（自動デレバレッジ）** | 利益が出ているポジションが強制デレバされることがある。片側だけADLされるとネイキッドポジション化 |
| **Agent Wallet** | 取引専用の委任ウォレット。メイン秘密鍵をVPSに置かずに取引権限のみ付与可能。**必ず使用すること** |
| **清算メカニクス** | CEXと異なりオラクルプライスベース。メンテナンスマージンはポジションサイズで動的変化。現物の含み益はパープ証拠金に算入されない |
| **ガス代** | HL上のトレード自体はガス代ゼロ。`withdraw_gas`はHL→Arbitrumブリッジ出金のArbitrum側ガス代 |
| **出金時間** | 通常数分だが混雑時30分以上。transfer_time: 300sは目安であり保証値ではない |
| **レート制限** | ~1200 req/min。Scanner+Executor+Collector同時稼働時に注意 |

---

## 3. 技術スタック

| レイヤー | 技術 |
|----------|------|
| 言語 | Python 3.11+ |
| FR監視 | Loris API + 取引所個別API（**二段構え**） |
| Hyperliquid接続 | hyperliquid-python-sdk（**Agent Wallet経由**） |
| オンチェーン操作 | web3.py（送金・ブリッジ。**approve額は必要最小限**） |
| CEX接続（Phase2） | ccxt |
| タスク管理 | asyncio + APScheduler |
| DB | SQLite（開発）→ **PostgreSQL**（本番。SQLAlchemy ORMで抽象化） |
| 監視UI | Streamlit or Grafana |
| 通知 | Discord webhook + Telegram（冗長化） |
| 死活監視 | **Healthchecks.io（デッドマンスイッチ）** |
| デプロイ | VPS (Hetzner/Vultr)、**Docker Compose** |
| CI/CD | GitHub Actions |
| **レートリミッター** | Token Bucket（取引所別） |
| **ログ管理** | RotatingFileHandler + logrotate |

---

## 4. セキュリティ設計 ★新規

### 4.1 秘密鍵管理

| レベル | 方法 | 用途 |
|--------|------|------|
| **メインウォレット** | ハードウェアウォレット（Ledger等）**VPSに絶対に置かない** | 大口資金保管、Bot用ウォレットへの補充（手動） |
| **Bot用ウォレット** | 運用額のみ保持。メインから必要分だけ送金 | 取引所への送金元 |
| **HL Agent Wallet** | Botが実際に使う委任ウォレット。**取引権限のみ、出金権限なし** | HLでの注文操作 |
| **CEX APIキー** | **IP制限 + 取引のみ（出金不可）** | Bybit/OKX注文 |

### 4.2 VPS セキュリティ
- SSH鍵認証のみ（パスワード無効化）、非標準ポート
- fail2ban + UFW（必要ポートのみ）
- Botプロセスは非rootユーザーで実行
- 秘密鍵ファイルは `chmod 600`
- Dashboard外部公開時は認証必須
- **キルスイッチ**: 外部（スマートフォン等）から1コマンドでBot停止 + 全ポジション決済

### 4.3 被害軽減（VPS侵害時）
- Agent Wallet → 取引はできるが出金不可（資金は盗めない）
- CEX APIキー → IP制限 + 出金不可設定
- Bot用ウォレットには運用額のみ（大口はハードウェアウォレット）
- 異常検知（想定外の大口取引）→ SMS/Telegram即時通知

---

## 5. タスク計画

### 凡例
- 👤 = ユーザー（k-hachiya）
- 🤖 = Claude
- 🤝 = 共同作業

---

### Phase 0: 準備（環境・アカウント）

| # | タスク | 担当 | 詳細 | 状態 |
|---|--------|------|------|------|
| 0-1 | Hyperliquid ウォレット準備 | 👤 | MetaMask等でArbitrumウォレット作成、HLに接続確認 | ⬜ |
| 0-2 | **HL Agent Wallet 作成** | 👤 | HL上でAgent Wallet設定（取引権限のみ委任） | ⬜ |
| 0-3 | USDC調達 | 👤 | Arbitrum上にUSDC準備（テスト用$100〜） | ⬜ |
| 0-4 | **HL Spot市場調査** | 🤝 | どの銘柄でCash&Carry可能か実板を確認 | ⬜ |
| 0-5 | Hyperliquid テストネット確認 | 👤 | テストネットで手動取引を1回試す | ⬜ |
| 0-6 | Discord Webhook作成 | 👤 | 通知用チャンネル + Webhook URL取得 | ⬜ |
| 0-7 | 開発環境セットアップ | 🤖 | pyproject.toml、依存関係、プロジェクト構成 | ⬜ |
| 0-8 | .env テンプレート作成 | 🤖 | AGENT_WALLET_KEY, DISCORD_WEBHOOK等の雛形 | ⬜ |

---

### Phase 1: コアエンジン（Hyperliquid単体）

| # | タスク | 担当 | 詳細 | 状態 |
|---|--------|------|------|------|
| 1-1 | FR Scanner モジュール | 🤖 | Loris API + HL API（二段構え）、Spot存在チェック含む | ⬜ |
| 1-2 | Hyperliquid SDK統合 | 🤖 | Agent Wallet経由、残高取得、注文、ポジション管理 | ⬜ |
| 1-3 | Executor モジュール | 🤖 | 指値注文、片足対策、ADL検知、FR再確認ゲート | ⬜ |
| 1-4 | Portfolio Manager | 🤖 | ベーシス込みNet P&L計算、ローテーション判定 | ⬜ |
| 1-5 | Recovery Manager | 🤖 | Sagaパターン、起動時リカバリ、片足検知 | ⬜ |
| 1-6 | リスク管理モジュール | 🤖 | レバ1.5x制限、清算価格監視、相関リスク警告 | ⬜ |
| 1-7 | レートリミッター | 🤖 | Token Bucket、429ハンドリング | ⬜ |
| 1-8 | ロガー & 通知 | 🤖 | JSONログ（ローテーション付き）+ Discord + Telegram | ⬜ |
| 1-9 | Orchestrator | 🤖 | 全モジュール統合、Graceful Shutdown、メインループ | ⬜ |
| 1-10 | テストネットで動作確認 | 🤝 | HLテストネットでE2Eテスト | ⬜ |

---

### Phase 2: Fund Router（資金自動ルーティング）

| # | タスク | 担当 | 詳細 | 状態 |
|---|--------|------|------|------|
| 2-1 | ウォレット残高監視 | 🤖 | Bot用ウォレットのUSDC残高をweb3.pyで監視 | ⬜ |
| 2-2 | Arbitrum→HL送金 | 🤖 | USDC送金、txハッシュDB保存 | ⬜ |
| 2-3 | HL→ウォレット出金 | 🤖 | ポジション決済後の出金自動化 | ⬜ |
| 2-4 | 送金確認・リトライ | 🤖 | 着金polling（タイムアウト付き）、指数バックオフ | ⬜ |

---

### Phase 3: 監視UI & 運用

| # | タスク | 担当 | 詳細 | 状態 |
|---|--------|------|------|------|
| 3-1 | Dashboard（Streamlit） | 🤖 | ポジション・PnL・ベーシス・FR履歴の可視化 | ⬜ |
| 3-2 | 外部死活監視セットアップ | 🤝 | Healthchecks.io + デッドマンスイッチ | ⬜ |
| 3-3 | VPSデプロイ | 🤝 | Docker Compose、Graceful Shutdown対応 | ⬜ |
| 3-4 | 本番稼働（小額） | 👤 | $100〜で本番テスト運用開始 | ⬜ |
| 3-5 | パラメータチューニング | 🤝 | FR閾値、保持期間、ポジションサイズ等 | ⬜ |

---

### Phase 4: マルチ取引所対応（DEX + CEX）

| # | タスク | 担当 | 詳細 | 状態 |
|---|--------|------|------|------|
| 4-1 | GMX SDK統合 | 🤖 | GMX V2 Perp注文・ポジション管理（ethers.js） | ⬜ |
| 4-2 | dYdX v4統合 | 🤖 | dYdX Cosmos chain対応、注文・ポジション管理 | ⬜ |
| 4-3 | BingX API統合 | 🤖 | ccxt経由、Perp注文・ポジション管理 | ⬜ |
| 4-4 | Phemex API統合 | 🤖 | ccxt経由、Perp注文・ポジション管理 | ⬜ |
| 4-5 | BingX/Phemex APIキー作成 | 👤 | アカウント作成 + APIキー発行（IP制限+出金不可） | ⬜ |
| 4-6 | Mode B Executor | 🤖 | Perp-Perp構築・決済・証拠金バランス監視 | ⬜ |
| 4-7 | クロス取引所 FR Scanner | 🤖 | HL/GMX/dYdX/BingX/Phemex間のFR差検出 | ⬜ |

### Phase 5: グレーゾーンCEX対応（オプション）

| # | タスク | 担当 | 詳細 | 状態 |
|---|--------|------|------|------|
| 5-1 | MEXC VIPアカウント調査 | 👤 | API制限解除の可能性を調査 | ⬜ |
| 5-2 | MEXC Playwrightモジュール | 🤖 | VIP不可の場合のブラウザ自動化（BANリスク認識の上） | ⬜ |
| 5-3 | Bitget API統合 | 🤖 | ccxt経由（FSA警告済みリスク認識の上） | ⬜ |
| 5-4 | KuCoin API統合 | 🤖 | ccxt経由（撤退リスク認識の上） | ⬜ |
| 5-5 | Bitget/KuCoin APIキー作成 | 👤 | アカウント + APIキー発行 | ⬜ |

---

## 6. 収益シミュレーション（Phase1: HL単体）

### 楽観シナリオ（FR 0.1% / 8h 継続）
- 運用額: $1,000
- 日次ネット: 0.26%
- **月利 ~8%** → 年利 ~155%

### 現実シナリオ（FR中央値 0.03% / 8h、機会選別で平均0.05%）
- 日次ネット: ~0.11%
- **月利 ~3.3%** → 年利 ~48%
- $1,000 → 12ヶ月で **~$1,480**

### 保守シナリオ（FR 0.03% / 8h + 待機期間あり）
- 稼働率70%（FR機会がない日はノーポジ）
- 日次ネット: ~0.05%
- **月利 ~1.5%** → 年利 ~20%

> **注意**: FR 0.1%/8h以上は上位10-20パーセンタイル。恒常的に取れる前提は危険。
> 現実的な持続可能ラインは**月利2-4%**。それでも年利27-60%（複利）で十分なリターン。

---

## 7. リスク管理

| リスク | 影響 | 対策 |
|--------|------|------|
| **HL Spot流動性不足** | Cash&Carry構築不可 | **Mode自動選択**: Spotあり→Mode A、なし→Mode B（Perp-Perp）、両方不可→スキップ |
| **Perp-Perp 証拠金片寄り** | 片側清算→ネイキッドポジション化 | 両側証拠金率リアルタイム監視、30%以下で即アラート、レバ1.2x以下で余裕確保 |
| **ベーシス変動** | FR収益の3-10倍の含み損益変動 | P&Lにベーシス含み損益を組み込み。急変時は撤退 |
| **ADL（自動デレバレッジ）** | 片足ネイキッドポジション化 | ADL検知 → もう片側も即決済 |
| **清算リスク** | パープ側が先に清算、現物だけ残る | **レバ1.5x以下**、証拠金率30%で強制撤退アラート |
| **FR急変（符号反転）** | 収益→支払いに転換 | エントリー前FR再確認、FR方向チェック（下降中は非推奨） |
| **片足約定** | 一方だけ約定し価格変動リスク | タイムアウト30秒 → taker強制約定 or 両方撤退 |
| **秘密鍵漏洩** | 全資金喪失 | Agent Wallet（取引のみ）、大口はハードウェアウォレット |
| **VPS侵害** | Bot乗っ取り | Agent Wallet + IP制限API + キルスイッチ |
| **MEXC アカウントBAN** | 資金凍結 | 出金ホワイトリスト、2FA必須。VIP申請を先に調査 |
| **Bot クラッシュ** | ポジション管理不能 | Recovery Manager（Sagaパターン）、外部死活監視 |
| **API レート制限超過** | IP ban → 管理不能 | Token Bucketレートリミッター、80%到達でアラート |
| **ブリッジ障害** | 送金中に資金スタック | txハッシュ永続化、タイムアウト、固定ブリッジリストのみ |
| **相関リスク** | 全ポジション同時悪化 | 全ポジ同方向警告、セクター分散推奨 |
| **ローテーション過多** | 手数料負けで赤字 | 最低保持24h、ヒステリシス付き判定、構築コスト回収チェック |
| **ネットワーク障害** | FR決済タイミング逃し | 外部ヘルスチェック、WebSocket再接続ロジック |
